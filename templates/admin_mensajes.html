{% extends 'base.html' %}
{% block title %}Admin - Mensajes{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-1"><i class="bi bi-envelope-fill"></i> Mensajes de Contacto</h1>
        <p class="text-muted">Gestiona los mensajes recibidos de clientes</p>
    </div>
    <div>
        <span class="badge bg-primary fs-6 me-2">
            Total: <span id="total-mensajes">0</span>
        </span>
        <span class="badge bg-danger fs-6">
            No leídos: <span id="no-leidos">0</span>
        </span>
    </div>
</div>

<!-- Filtros -->
<div class="mb-4">
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary active" onclick="filtrarMensajes('todos')">
            <i class="bi bi-envelope"></i> Todos
        </button>
        <button type="button" class="btn btn-outline-danger" onclick="filtrarMensajes('no-leidos')">
            <i class="bi bi-envelope-exclamation"></i> No Leídos
        </button>
        <button type="button" class="btn btn-outline-success" onclick="filtrarMensajes('leidos')">
            <i class="bi bi-envelope-check"></i> Leídos
        </button>
    </div>
</div>

<!-- Listado de mensajes -->
<div id="listadoMensajes">
    <!-- Aquí se cargarán los mensajes dinámicamente -->
</div>

<!-- Modal para ver mensaje completo -->
<div class="modal fade" id="modalMensaje" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-envelope-open"></i> Mensaje de <span id="modal-nombre"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong><i class="bi bi-person"></i> Nombre:</strong>
                    <p id="modal-nombre-completo"></p>
                </div>
                <div class="mb-3">
                    <strong><i class="bi bi-envelope"></i> Email:</strong>
                    <p><a href="#" id="modal-email"></a></p>
                </div>
                <div class="mb-3">
                    <strong><i class="bi bi-calendar"></i> Fecha:</strong>
                    <p id="modal-fecha"></p>
                </div>
                <div class="mb-3">
                    <strong><i class="bi bi-chat-left-text"></i> Mensaje:</strong>
                    <p id="modal-mensaje" class="border p-3 rounded bg-light"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let mensajes = [];
    let filtroActual = 'todos';
    let modal;
    
    document.addEventListener('DOMContentLoaded', function() {
        modal = new bootstrap.Modal(document.getElementById('modalMensaje'));
        cargarMensajes();
        cargarEstadisticas();
    });
    
    async function cargarMensajes() {
        try {
            const response = await fetch('/api/mensajes');
            mensajes = await response.json();
            
            renderizarMensajes();
        } catch (error) {
            console.error('Error al cargar mensajes:', error);
        }
    }
    
    async function cargarEstadisticas() {
        try {
            const response = await fetch('/api/mensajes/stats');
            const stats = await response.json();
            
            document.getElementById('total-mensajes').textContent = stats.total;
            document.getElementById('no-leidos').textContent = stats.no_leidos;
        } catch (error) {
            console.error('Error al cargar estadísticas:', error);
        }
    }
    
    function renderizarMensajes() {
        const listado = document.getElementById('listadoMensajes');
        
        let mensajesFiltrados = mensajes;
        
        if (filtroActual === 'no-leidos') {
            mensajesFiltrados = mensajes.filter(m => !m.leido);
        } else if (filtroActual === 'leidos') {
            mensajesFiltrados = mensajes.filter(m => m.leido);
        }
        
        if (mensajesFiltrados.length === 0) {
            listado.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                    <p class="text-muted mt-3">No hay mensajes</p>
                </div>
            `;
            return;
        }
        
        listado.innerHTML = '';
        
        mensajesFiltrados.forEach(m => {
            const leidoClass = m.leido ? 'border-start-success' : 'border-start-danger';
            const leidoBadge = m.leido 
                ? '<span class="badge bg-success">Leído</span>' 
                : '<span class="badge bg-danger">No leído</span>';
            
            const fechaFormato = new Date(m.fecha).toLocaleString('es-AR');
            
            listado.innerHTML += `
                <div class="card mb-3 shadow-sm border-start border-5 ${leidoClass}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h5 class="card-title mb-1">
                                    <i class="bi bi-person-circle"></i> ${m.nombre}
                                </h5>
                                <p class="text-muted small mb-0">
                                    <i class="bi bi-envelope"></i> ${m.email}
                                </p>
                            </div>
                            <div class="text-end">
                                ${leidoBadge}
                                <p class="text-muted small mb-0 mt-1">
                                    <i class="bi bi-clock"></i> ${fechaFormato}
                                </p>
                            </div>
                        </div>
                        <p class="card-text mt-3">${m.mensaje.substring(0, 150)}${m.mensaje.length > 150 ? '...' : ''}</p>
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-primary" onclick="verMensaje('${m._id}')">
                                <i class="bi bi-eye"></i> Ver completo
                            </button>
                            <button class="btn btn-sm ${m.leido ? 'btn-outline-warning' : 'btn-success'}" 
                                    onclick="toggleLeido('${m._id}', ${!m.leido})">
                                <i class="bi bi-${m.leido ? 'envelope' : 'check'}"></i> 
                                ${m.leido ? 'Marcar no leído' : 'Marcar leído'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="eliminarMensaje('${m._id}')">
                                <i class="bi bi-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    function filtrarMensajes(filtro) {
        filtroActual = filtro;
        
        // Actualizar botones activos
        document.querySelectorAll('.btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.closest('button').classList.add('active');
        
        renderizarMensajes();
    }
    
    async function verMensaje(id) {
        const mensaje = mensajes.find(m => m._id === id);
        
        if (!mensaje) return;
        
        document.getElementById('modal-nombre').textContent = mensaje.nombre;
        document.getElementById('modal-nombre-completo').textContent = mensaje.nombre;
        
        const emailLink = document.getElementById('modal-email');
        emailLink.textContent = mensaje.email;
        emailLink.href = `mailto:${mensaje.email}`;
        
        document.getElementById('modal-fecha').textContent = new Date(mensaje.fecha).toLocaleString('es-AR');
        document.getElementById('modal-mensaje').textContent = mensaje.mensaje;
        
        modal.show();
        
        // Marcar como leído automáticamente
        if (!mensaje.leido) {
            await toggleLeido(id, true);
        }
    }
    
    async function toggleLeido(id, leido) {
        try {
            const response = await fetch(`/api/mensajes/${id}/leido`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({leido: leido})
            });
            
            if (response.ok) {
                await cargarMensajes();
                await cargarEstadisticas();
            }
        } catch (error) {
            console.error('Error al actualizar mensaje:', error);
        }
    }
    
    async function eliminarMensaje(id) {
        if (!confirm('¿Estás seguro de eliminar este mensaje?')) return;
        
        try {
            const response = await fetch(`/api/mensajes/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                await cargarMensajes();
                await cargarEstadisticas();
                mostrarAlerta('Mensaje eliminado', 'success');
            }
        } catch (error) {
            console.error('Error al eliminar mensaje:', error);
        }
    }
    
    function mostrarAlerta(mensaje, tipo) {
        const alertaHTML = `
            <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        document.querySelector('.container').insertAdjacentHTML('afterbegin', alertaHTML);
        
        setTimeout(() => {
            document.querySelector('.alert')?.remove();
        }, 3000);
    }
</script>
{% endblock %}