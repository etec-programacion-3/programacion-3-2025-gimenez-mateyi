<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planes de Financiación</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="index.html">
      <i class="bi bi-car-front-fill"></i> Giménez Automotores
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="catalogo.html">Catálogo</a></li>
        <li class="nav-item"><a class="nav-link active" href="planes.html">Planes</a></li>
        <li class="nav-item"><a class="nav-link" href="quienes_somos.html">Quiénes Somos</a></li>
        <li class="nav-item"><a class="nav-link" href="contacto.html">Contacto</a></li>
        <li class="nav-item" id="auth-menu">
          <a class="nav-link" href="login.html">Iniciar Sesión</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- HERO SECTION -->
<section class="hero">
  <div class="container">
    <h2>Planes de Financiación</h2>
    <p>Encuentra el plan que se ajuste a tu presupuesto</p>
  </div>
</section>

<!-- PLANES -->
<section class="container my-5">
  <h2 class="section-title">Nuestras Opciones de Financiación</h2>
  <div id="plans-list" class="plans-container">
    <p class="text-center">Cargando planes...</p>
  </div>
</section>

<!-- CALCULADORA -->
<section class="container my-5">
  <h2 class="section-title">Calculadora de Cuotas</h2>
  <div class="row">
    <div class="col-lg-6 mx-auto">
      <div class="form-container">
        <h4>Simula tu financiación</h4>
        
        <div class="form-group">
          <label for="calc-plan"><strong>Selecciona un plan:</strong></label>
          <select id="calc-plan" class="form-select">
            <option value="">-- Seleccionar --</option>
          </select>
        </div>

        <div class="form-group">
          <label for="calc-monto"><strong>Monto del vehículo ($):</strong></label>
          <input type="number" id="calc-monto" class="form-control" placeholder="Ej: 6500000" min="0">
        </div>

        <div class="form-group">
          <label for="calc-enganche"><strong>Enganche ($):</strong></label>
          <input type="number" id="calc-enganche" class="form-control" placeholder="Opcional" min="0" value="0">
        </div>

        <button class="btn btn-primary w-100" onclick="calculateQuota()">Calcular Cuota</button>
      </div>

      <div id="result-container" class="alert alert-info mt-3" style="display: none;">
        <h5>Resultado</h5>
        <p id="result-text"></p>
      </div>
    </div>
  </div>
</section>

<!-- FOOTER -->
<footer>
  <p>&copy; 2025 Giménez Automotores - Todos los derechos reservados</p>
</footer>

<!-- Scripts -->
<script src="js/config.js"></script>
<script src="js/api.js"></script>
<script>
let allPlans = [];

document.addEventListener('DOMContentLoaded', async () => {
  await loadPlans();
  updateAuthMenu();
});

async function loadPlans() {
  try {
    allPlans = await api.getPlans();

    if (!allPlans || allPlans.length === 0) {
      document.getElementById('plans-list').innerHTML = 
        '<p class="text-center text-muted">No hay planes disponibles</p>';
      return;
    }

    // Renderizar tarjetas de planes
    document.getElementById('plans-list').innerHTML = allPlans.map(plan => `
      <div class="plan-card ${plan.destacado ? 'featured' : ''}">
        ${plan.destacado ? '<div class="badge">Destacado</div>' : ''}
        <h3>${plan.nombre}</h3>
        <p class="subtitle">${plan.descripcion || ''}</p>
        <ul>
          ${plan.beneficios ? plan.beneficios.map(b => `<li>${b}</li>`).join('') : ''}
        </ul>
        <div class="price">${plan.cuotas ? `Hasta ${plan.cuotas} cuotas` : 'Consultar'}</div>
        <button class="btn" onclick="selectPlan('${plan._id}', '${plan.nombre}')">
          Seleccionar este plan
        </button>
      </div>
    `).join('');

    // Llenar selector de planes
    document.getElementById('calc-plan').innerHTML = `
      <option value="">-- Seleccionar --</option>
      ${allPlans.map(p => `<option value="${p._id}">${p.nombre}</option>`).join('')}
    `;

  } catch (error) {
    console.error('Error:', error);
    document.getElementById('plans-list').innerHTML = 
      '<p class="text-center text-danger">Error al cargar los planes</p>';
  }
}

function selectPlan(planId, planName) {
  document.getElementById('calc-plan').value = planId;
  alert(`Plan "${planName}" seleccionado. Ahora usa la calculadora para simular tu cuota.`);
  document.querySelector('html, body').scrollTop = document.querySelector('#result-container').offsetTop;
}

async function calculateQuota() {
  const planId = document.getElementById('calc-plan').value;
  const monto = parseInt(document.getElementById('calc-monto').value) || 0;
  const enganche = parseInt(document.getElementById('calc-enganche').value) || 0;

  if (!planId || monto === 0) {
    alert('Por favor completa todos los campos');
    return;
  }

  try {
    const result = await api.calculatePayment(planId, monto, enganche);
    
    const resultContainer = document.getElementById('result-container');
    const resultText = document.getElementById('result-text');

    if (result.cuota) {
      resultText.innerHTML = `
        <strong>Monto a financiar:</strong> $${(monto - enganche).toLocaleString('es-AR')}<br>
        <strong>Cuota mensual:</strong> <span style="font-size: 1.5rem; color: #0d6efd;">$${Number(result.cuota).toLocaleString('es-AR')}</span><br>
        ${result.tasa ? `<strong>Tasa de interés:</strong> ${result.tasa}%<br>` : ''}
        ${result.plazo ? `<strong>Plazo:</strong> ${result.plazo} meses` : ''}
      `;
      resultContainer.style.display = 'block';
    } else {
      resultText.innerHTML = 'No se pudo calcular la cuota. Por favor intenta de nuevo.';
      resultContainer.style.display = 'block';
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

function updateAuthMenu() {
  const user = JSON.parse(localStorage.getItem('user'));
  const authMenu = document.getElementById('auth-menu');
  
  if (user) {
    authMenu.innerHTML = `
      <span class="nav-link">Hola, <strong>${user.username}</strong></span>
      <button class="btn btn-logout" onclick="logout()">Cerrar sesión</button>
    `;
  }
}

function logout() {
  api.logout();
  location.reload();
}
</script>

</body>
</html>